--------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/kahrens/MyProjects/pystacked/cert/log_cs_pystacked_class.txt
  log type:  text
 opened on:  18 Feb 2022, 14:37:39

. 
. clear all

. 
. if "`c(username)'"=="kahrens" {
.         adopath + "/Users/kahrens/MyProjects/pystacked"
  [1]  (BASE)      "/Applications/Stata 16/ado/base/"
  [2]  (SITE)      "/Applications/Stata 16/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/kahrens/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/kahrens/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/kahrens/MyProjects/pystacked"
. }

. else if "`c(username)'"=="ecomes" {
.         adopath + "/Users/ecomes/Documents/GitHub/pystacked/cert"
. }

. else {
.         net install pystacked, ///
>                 from(https://raw.githubusercontent.com/aahrens1/pystacked/main) replace
. }

. which pystacked 
/Users/kahrens/MyProjects/pystacked/pystacked.ado
*! pystacked v0.4.1
*! last edited: 18feb2022
*! authors: aa/ms

. python: import sklearn

. python: sklearn.__version__
'1.0'

. 
. tempfile testdata

. global model v58 v1-v30

. insheet using https://archive.ics.uci.edu/ml/machine-learning-databases/spambase/spambase.data, clear comma
(58 vars, 4,601 obs)

. sample 50
(2,300 observations deleted)

. gen u = runiform()

. gen train = u<0.5

. gen train2 = u<.75

. save `testdata'
file /var/folders/hj/47q1qh7d7g12z31w_539my0w0000gs/T//S_23998.000001 saved

. 
. *******************************************************************************
. *** try voting                                                                                                    
>                       ***
. *******************************************************************************
. 
. use `testdata', clear

.                         
. pystacked $model, type(class) pyseed(123) ///
>                                                         methods(lassocv rf logit) /// 
>                                                         njobs(4) pipe1(poly2) ///
>                                                         voting voteweights(0.1 .4) ///
>                                                         votetype(soft)
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  lassocv        |      0.1000000
  rf             |      0.4000000
  logit          |      0.5000000

.                         
. 
. *******************************************************************************
. *** try other estimators                                                                                          
>               ***
. *******************************************************************************
. 
. use `testdata', clear

. 
. local m1 logit lassocv gradboost nnet

. local m2 logit lassocv rf nnet

. local m3 logit ridgecv gradboost nnet

. local m4 logit elasticcv gradboost nnet

. local m5 logit elasticcv gradboost svm

. 
. foreach m in "`m1'" "`m2'" "`m3'" "`m4'" "`m5'" "`m6'" {
  2.         di "`m'"
  3.         pystacked $model, type(class) pyseed(123) ///
>                                                         methods(`m') /// 
>                                                         njobs(4)
  4. }
logit lassocv gradboost nnet
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0000000
  lassocv        |      0.0000000
  gradboost      |      0.3711264
  nnet           |      0.6288736
logit lassocv rf nnet
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0000000
  lassocv        |      0.0000000
  rf             |      0.4820447
  nnet           |      0.5179553
logit ridgecv gradboost nnet
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0000000
  ridgecv        |      0.0000000
  gradboost      |      0.3711264
  nnet           |      0.6288736
logit elasticcv gradboost nnet
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0000000
  elasticcv      |      0.0000000
  gradboost      |      0.3711264
  nnet           |      0.6288736
logit elasticcv gradboost svm
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0995764
  elasticcv      |      0.0000000
  gradboost      |      0.7546517
  svm            |      0.1457719

Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.1673696
  lassocv        |      0.0000000
  gradboost      |      0.8326304

. 
. *******************************************************************************
. *** check that predicted value = weighted avg of transform variables            ***
. *******************************************************************************
.                                                  
. use `testdata', clear

. 
. pystacked $model, type(class) pyseed(123)
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.1673647
  lassocv        |      0.0000000
  gradboost      |      0.8326353

. 
. predict double yhat, pr

. list yhat if _n < 10

      +-----------+
      |      yhat |
      |-----------|
   1. | .43349238 |
   2. | .76472662 |
   3. | .98266781 |
   4. | .70136324 |
   5. | .33060945 |
      |-----------|
   6. | .86920261 |
   7. | .05238366 |
   8. | .97237024 |
   9. | .11488798 |
      +-----------+

. 
. predict double t, transform  

. 
. mat W = e(weights)

. gen myhat = t1*el(W,1,1)+t2*el(W,2,1)+t3*el(W,3,1)

. 
. assert reldif(yhat,myhat)<0.0001

. 
. 
. *******************************************************************************
. *** check table option                                                                                            
>               ***
. *******************************************************************************
. 
. use `testdata', clear

. 
. // holdout sample 1
. cap drop h1

. gen h1 = !train2

. 
. // full sample
. pystacked $model, type(class) pyseed(123) methods(logit rf gradboost)
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.1166825
  rf             |      0.6261173
  gradboost      |      0.2572003

. pystacked, table

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .      1355      10         .       .
  STACKING     1 |    .        36     900         .       .
  logit        0 | 0.117     1280      85         .       .
  logit        1 | 0.117      157     779         .       .
  rf           0 | 0.626     1365       0         .       .
  rf           1 | 0.626       20     916         .       .
  gradboost    0 | 0.257     1312      53         .       .
  gradboost    1 | 0.257       85     851         .       .

. 
. // with holdout sample
. pystacked $model if train, type(class) pyseed(123) methods(logit rf gradboost)
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.2048669
  rf             |      0.5685456
  gradboost      |      0.2265875

. // default holdout - all available obs
. pystacked, table holdout
Number of holdout observations: 1155

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .       676       4       640      45
  STACKING     1 |    .        17     449        57     413
  logit        0 | 0.205      647      33       636      49
  logit        1 | 0.205       73     393        76     394
  rf           0 | 0.569      679       1       635      50
  rf           1 | 0.569        9     457        61     409
  gradboost    0 | 0.227      663      17       633      52
  gradboost    1 | 0.227       35     431        65     405

. // specified holdout sample
. pystacked, table holdout(h1)
Number of holdout observations:  549

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .       676       4       295      23
  STACKING     1 |    .        17     449        29     202
  logit        0 | 0.205      647      33       293      25
  logit        1 | 0.205       73     393        38     193
  rf           0 | 0.569      679       1       291      27
  rf           1 | 0.569        9     457        32     199
  gradboost    0 | 0.227      663      17       290      28
  gradboost    1 | 0.227       35     431        36     195

. 
. // as pystacked option
. pystacked $model if train, type(class) pyseed(123) ///
>         methods(logit rf gradboost) table holdout
Number of holdout observations: 1155

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .       676       4       640      45
  STACKING     1 |    .        17     449        57     413
  logit        0 | 0.205      647      33       636      49
  logit        1 | 0.205       73     393        76     394
  rf           0 | 0.569      679       1       635      50
  rf           1 | 0.569        9     457        61     409
  gradboost    0 | 0.227      663      17       633      52
  gradboost    1 | 0.227       35     431        65     405

. 
. // syntax 2
. pystacked $model || method(logit) || method(rf) || method(gradboost) || if train, ///
>         type(class) pyseed(123)
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.2048669
  rf             |      0.5685456
  gradboost      |      0.2265875

. pystacked, table holdout
Number of holdout observations: 1155

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .       676       4       640      45
  STACKING     1 |    .        17     449        57     413
  logit        0 | 0.205      647      33       636      49
  logit        1 | 0.205       73     393        76     394
  rf           0 | 0.569      679       1       635      50
  rf           1 | 0.569        9     457        61     409
  gradboost    0 | 0.227      663      17       633      52
  gradboost    1 | 0.227       35     431        65     405

. 
. 
. *******************************************************************************
. *** check graph option                                                                                            
>               ***
. *******************************************************************************
. 
. use `testdata', clear

. 
. // holdout sample 1
. cap drop h1

. gen h1 = !train2

. 
. // full sample
. pystacked $model, type(class) pyseed(123) methods(logit rf gradboost)
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.1166825
  rf             |      0.6261173
  gradboost      |      0.2572003

. pystacked, graph

. 
. // with holdout sample
. pystacked $model if train, type(class) pyseed(123) methods(logit rf gradboost)
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.2048669
  rf             |      0.5685456
  gradboost      |      0.2265875

. // default holdout - all available obs
. pystacked, graph holdout
Number of holdout observations: 1155

. // specified holdout sample
. pystacked, graph holdout(h1)
Number of holdout observations:  549

. // histogram option
. pystacked, graph hist holdout
Number of holdout observations: 1155

. // graphing options - combined graph
. pystacked, graph(subtitle("subtitle goes here")) holdout
Number of holdout observations: 1155

. // graphing options - learner graphs
. pystacked, lgraph(percent) hist holdout
Number of holdout observations: 1155

. 
. // as pystacked option
. pystacked $model if train, type(class) pyseed(123) ///
>         methods(logit rf gradboost) graph holdout
Number of holdout observations: 1155

. 
. // syntax 2
. pystacked $model || method(logit) || method(rf) || method(gradboost) || if train, ///
>         type(class) pyseed(123)
Stacking weights:
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.2048669
  rf             |      0.5685456
  gradboost      |      0.2265875

. pystacked, graph holdout
Number of holdout observations: 1155

. 
. 
. log close
      name:  <unnamed>
       log:  /Users/kahrens/MyProjects/pystacked/cert/log_cs_pystacked_class.txt
  log type:  text
 closed on:  18 Feb 2022, 14:42:05
--------------------------------------------------------------------------------------------------------------------
