-----------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/kahrens/MyProjects/pystacked/cert/log_cs_pystacked_class.txt
  log type:  text
 opened on:  17 Feb 2022, 17:58:26

. 
. clear all

. 
. if "`c(username)'"=="kahrens" {
.         adopath + "/Users/kahrens/MyProjects/pystacked"
  [1]  (BASE)      "/Applications/Stata 16/ado/base/"
  [2]  (SITE)      "/Applications/Stata 16/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/kahrens/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/kahrens/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/kahrens/MyProjects/pystacked"
. }

. else if "`c(username)'"=="ecomes" {
.         adopath + "/Users/ecomes/Documents/GitHub/pystacked/cert"
. }

. else {
.         net install pystacked, ///
>                 from(https://raw.githubusercontent.com/aahrens1/pystacked/main) replace
. }

. which pystacked 
/Users/kahrens/MyProjects/pystacked/pystacked.ado
*! pystacked v0.4
*! last edited: 17feb2022
*! authors: aa/ms

. python: import sklearn

. python: sklearn.__version__
'1.0'

. 
. tempfile testdata

. global model v58 v1-v30

. insheet using https://archive.ics.uci.edu/ml/machine-learning-databases/spambase/spambase.data, clear comma
(58 vars, 4,601 obs)

. sample 50
(2,300 observations deleted)

. gen u = runiform()

. gen train = u<0.5

. gen train2 = u<.75

. save `testdata'
file /var/folders/hj/47q1qh7d7g12z31w_539my0w0000gs/T//S_97337.000001 saved

. 
. *******************************************************************************
. *** try voting                                                                                                 
>                          ***
. *******************************************************************************
. 
. use `testdata', clear

.                         
. pystacked $model, type(class) pyseed(123) ///
>                                                         methods(lassocv rf logit) /// 
>                                                         njobs(4) pipe1(poly2) ///
>                                                         voting voteweights(0.1 .4) ///
>                                                         votetype(soft)
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  lassocv        |      0.1000000
  rf             |      0.4000000
  logit          |      0.5000000

.                         
. 
. *******************************************************************************
. *** try other estimators                                                                                       
>                  ***
. *******************************************************************************
. 
. use `testdata', clear

. 
. local m1 logit lassocv gradboost nnet

. local m2 logit lassocv rf nnet

. local m3 logit ridgecv gradboost nnet

. local m4 logit elasticcv gradboost nnet

. local m5 logit elasticcv gradboost svm

. local m6 logit elasticcv gradboost linsvm

. 
. foreach m in "`m1'" "`m2'" "`m3'" "`m4'" "`m5'" "`m6'" {
  2.         di "`m'"
  3.         pystacked $model, type(class) pyseed(123) ///
>                                                         methods(`m') /// 
>                                                         njobs(4)
  4. }
logit lassocv gradboost nnet
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0000000
  lassocv        |      0.0000000
  gradboost      |      0.5998200
  nnet           |      0.4001800
logit lassocv rf nnet
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0647179
  lassocv        |      0.0000000
  rf             |      0.5599447
  nnet           |      0.3753375
logit ridgecv gradboost nnet
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0000000
  ridgecv        |      0.0000000
  gradboost      |      0.5998200
  nnet           |      0.4001800
logit elasticcv gradboost nnet
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0000000
  elasticcv      |      0.0000000
  gradboost      |      0.5998200
  nnet           |      0.4001800
logit elasticcv gradboost svm
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.1114366
  elasticcv      |      0.0000000
  gradboost      |      0.8788682
  svm            |      0.0096952
logit elasticcv gradboost linsvm
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.1139734
  elasticcv      |      0.0000000
  gradboost      |      0.8846829
  linsvm         |      0.0013437

. 
. *******************************************************************************
. *** check that predicted value = weighted avg of transform variables            ***
. *******************************************************************************
.                                                  
. use `testdata', clear

. 
. pystacked $model, type(class) pyseed(123)
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.1203255
  lassocv        |      0.0000000
  gradboost      |      0.8796745

. 
. predict double yhat, pr

. list yhat if _n < 10

      +-----------+
      |      yhat |
      |-----------|
   1. | .12440336 |
   2. | .09654456 |
   3. | .01708139 |
   4. | .97441519 |
   5. | .67854875 |
      |-----------|
   6. | .91155256 |
   7. |  .0312939 |
   8. | .10774842 |
   9. | .99692457 |
      +-----------+

. 
. predict double t, transform  

. 
. mat W = e(weights)

. gen myhat = t1*el(W,1,1)+t2*el(W,2,1)+t3*el(W,3,1)

. 
. assert reldif(yhat,myhat)<0.0001

. 
. 
. *******************************************************************************
. *** check table option                                                                                         
>                  ***
. *******************************************************************************
. 
. use `testdata', clear

. 
. // holdout sample 1
. cap drop h1

. gen h1 = !train2

. 
. // full sample
. pystacked $model, type(class) pyseed(123) methods(logit rf gradboost)
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0877159
  rf             |      0.4804884
  gradboost      |      0.4317957

. pystacked, table

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .      1375      15         .       .
  STACKING     1 |    .        54     857         .       .
  logit        0 | 0.088     1318      72         .       .
  logit        1 | 0.088      160     751         .       .
  rf           0 | 0.480     1390       0         .       .
  rf           1 | 0.480       19     892         .       .
  gradboost    0 | 0.432     1342      48         .       .
  gradboost    1 | 0.432       81     830         .       .

. 
. // with holdout sample
. pystacked $model if train, type(class) pyseed(123) methods(logit rf gradboost)
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.2517107
  rf             |      0.2483638
  gradboost      |      0.4999255

. // default holdout - all available obs
. pystacked, table holdout
Number of holdout observations: 1143

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .       684      18       646      42
  STACKING     1 |    .        31     425        56     399
  logit        0 | 0.252      665      37       638      50
  logit        1 | 0.252       73     383        86     369
  rf           0 | 0.248      702       0       647      41
  rf           1 | 0.248        8     448        60     395
  gradboost    0 | 0.500      682      20       640      48
  gradboost    1 | 0.500       30     426        63     392

. // specified holdout sample
. pystacked, table holdout(h1)
Number of holdout observations:  550

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .       684      18       311      23
  STACKING     1 |    .        31     425        29     187
  logit        0 | 0.252      665      37       308      26
  logit        1 | 0.252       73     383        45     171
  rf           0 | 0.248      702       0       311      23
  rf           1 | 0.248        8     448        27     189
  gradboost    0 | 0.500      682      20       308      26
  gradboost    1 | 0.500       30     426        31     185

. 
. // as pystacked option
. pystacked $model if train, type(class) pyseed(123) ///
>         methods(logit rf gradboost) table holdout
Number of holdout observations: 1143

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .       684      18       646      42
  STACKING     1 |    .        31     425        56     399
  logit        0 | 0.252      665      37       638      50
  logit        1 | 0.252       73     383        86     369
  rf           0 | 0.248      702       0       647      41
  rf           1 | 0.248        8     448        60     395
  gradboost    0 | 0.500      682      20       640      48
  gradboost    1 | 0.500       30     426        63     392

. 
. // syntax 2
. pystacked $model || method(logit) || method(rf) || method(gradboost) || if train, ///
>         type(class) pyseed(123)
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.2517107
  rf             |      0.2483638
  gradboost      |      0.4999255

. pystacked, table holdout
Number of holdout observations: 1143

Confusion matrix: In-Sample and Out-of-Sample
------------------------------------------------------------
  Method         | Weight      In-Sample       Out-of-Sample
                 |             0       1         0       1  
-----------------+------------------------------------------
  STACKING     0 |    .       684      18       646      42
  STACKING     1 |    .        31     425        56     399
  logit        0 | 0.252      665      37       638      50
  logit        1 | 0.252       73     383        86     369
  rf           0 | 0.248      702       0       647      41
  rf           1 | 0.248        8     448        60     395
  gradboost    0 | 0.500      682      20       640      48
  gradboost    1 | 0.500       30     426        63     392

. 
. 
. *******************************************************************************
. *** check graph option                                                                                         
>                  ***
. *******************************************************************************
. 
. use `testdata', clear

. 
. // holdout sample 1
. cap drop h1

. gen h1 = !train2

. 
. // full sample
. pystacked $model, type(class) pyseed(123) methods(logit rf gradboost)
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.0877159
  rf             |      0.4804884
  gradboost      |      0.4317957

. pystacked, graph

. 
. // with holdout sample
. pystacked $model if train, type(class) pyseed(123) methods(logit rf gradboost)
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.2517107
  rf             |      0.2483638
  gradboost      |      0.4999255

. // default holdout - all available obs
. pystacked, graph holdout
Number of holdout observations: 1143

. // specified holdout sample
. pystacked, graph holdout(h1)
Number of holdout observations:  550

. // histogram option
. pystacked, graph hist holdout
Number of holdout observations: 1143

. // graphing options - combined graph
. pystacked, graph(subtitle("subtitle goes here")) holdout
Number of holdout observations: 1143

. // graphing options - learner graphs
. pystacked, lgraph(percent) hist holdout
Number of holdout observations: 1143

. 
. // as pystacked option
. pystacked $model if train, type(class) pyseed(123) ///
>         methods(logit rf gradboost) graph holdout
Number of holdout observations: 1143

. 
. // syntax 2
. pystacked $model || method(logit) || method(rf) || method(gradboost) || if train, ///
>         type(class) pyseed(123)
---------------------------------------
  Method         |      Weight
-----------------+---------------------
  logit          |      0.2517107
  rf             |      0.2483638
  gradboost      |      0.4999255

. pystacked, graph holdout
Number of holdout observations: 1143

. 
. 
. log close
      name:  <unnamed>
       log:  /Users/kahrens/MyProjects/pystacked/cert/log_cs_pystacked_class.txt
  log type:  text
 closed on:  17 Feb 2022, 18:05:55
-----------------------------------------------------------------------------------------------------------------
